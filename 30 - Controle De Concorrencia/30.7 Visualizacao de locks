 VisualizaÃ§Ã£o de Locks no PostgreSQL
ğŸ§  Por que visualizar locks?
Imagine que vocÃª estÃ¡ em uma lanchonete com um Ãºnico caixa. Cada cliente (transaÃ§Ã£o) precisa de acesso exclusivo ao caixa (dados). Se dois clientes tentarem pagar ao mesmo tempo, um precisa esperar. Se ninguÃ©m sabe quem estÃ¡ no caixa, todos ficam perdidos. O mesmo acontece com o banco de dados. Ver os locks ajuda a entender quem estÃ¡ usando o quÃª e por quÃª.

ğŸ“Š Tabela para ver locks: pg_locks
Essa tabela mostra todos os locks ativos no momento no banco de dados.

sql
Copy
Edit
SELECT * FROM pg_locks;
SÃ³ que ela traz muita informaÃ§Ã£o crua. Vamos filtrÃ¡-la e deixÃ¡-la mais Ãºtil:

ğŸ” Visualizando locks com mais detalhes
sql
Copy
Edit
SELECT
    pg_stat_activity.pid,
    pg_stat_activity.query,
    pg_locks.locktype,
    pg_locks.mode,
    pg_locks.granted,
    pg_class.relname AS tabela
FROM pg_locks
JOIN pg_stat_activity ON pg_locks.pid = pg_stat_activity.pid
LEFT JOIN pg_class ON pg_locks.relation = pg_class.oid
WHERE pg_stat_activity.datname = current_database();
ğŸ§¾ O que essas colunas mostram?
Coluna	Significado
pid	ID do processo (transaÃ§Ã£o)
query	Consulta que estÃ¡ sendo executada
locktype	Tipo de lock (linha, tabela etc.)
mode	Tipo de bloqueio (ex: RowExclusiveLock, AccessShareLock...)
granted	Se o lock jÃ¡ foi concedido (true) ou estÃ¡ esperando (false)
relname	Nome da tabela bloqueada

ğŸ” Exemplo da vida real
Imagine um sistema de pedidos de pizzaria.
O funcionÃ¡rio 1 comeÃ§a a atualizar o pedido do cliente A:

sql
Copy
Edit
BEGIN;
UPDATE pedidos SET status = 'Em produÃ§Ã£o' WHERE id = 101;
-- pausa aqui sem COMMIT
Enquanto isso, o funcionÃ¡rio 2 tenta:

sql
Copy
Edit
UPDATE pedidos SET status = 'Entregue' WHERE id = 101;
Essa segunda consulta vai ficar esperando, porque a linha jÃ¡ estÃ¡ bloqueada.
Se vocÃª rodar a consulta da pg_locks, verÃ¡ que hÃ¡ um processo com lock concedido e outro esperando.

ğŸ”§ Dica prÃ¡tica: ver apenas os locks em espera
sql
Copy
Edit
SELECT 
    a.pid,
    a.query,
    l.mode,
    l.locktype,
    c.relname
FROM pg_locks l
JOIN pg_stat_activity a ON l.pid = a.pid
LEFT JOIN pg_class c ON l.relation = c.oid
WHERE NOT l.granted;
ğŸ’£ Quer matar uma transaÃ§Ã£o que estÃ¡ travando o banco?
VocÃª pode encerrar uma transaÃ§Ã£o travada (com cuidado!):

sql
Copy
Edit
SELECT pg_terminate_backend(PID);
Substitua PID pelo nÃºmero do processo travado que vocÃª viu na consulta anterior.

ğŸ“Œ Slide resumo sugerido
Comando / Consulta	Utilidade
SELECT * FROM pg_locks	Mostra todos os locks
Consulta com pg_locks + pg_stat_activity	Mostra quem estÃ¡ bloqueando o quÃª
WHERE NOT granted	VÃª quem estÃ¡ esperando por lock
pg_terminate_backend(pid)	Encerra a transaÃ§Ã£o que estÃ¡ travando
