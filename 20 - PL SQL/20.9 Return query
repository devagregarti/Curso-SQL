üîÑ RETURN QUERY no PL/pgSQL
1. O que √© o RETURN QUERY?
RETURN QUERY √© uma forma de uma fun√ß√£o em PL/pgSQL devolver o resultado de uma consulta (SELECT) para quem chamou a fun√ß√£o.

Permite que a fun√ß√£o retorne v√°rias linhas e colunas ao inv√©s de um √∫nico valor.

Usado principalmente em fun√ß√µes que retornam tabelas ou conjuntos de dados.

2. Quando usar RETURN QUERY?
Quando voc√™ quer que a fun√ß√£o retorne uma lista de registros (v√°rias linhas).

√ötil para encapsular consultas complexas em fun√ß√µes.

Ajuda a organizar e reaproveitar consultas SQL dentro de fun√ß√µes.

3. Como funciona na pr√°tica?
Dentro da fun√ß√£o, voc√™ escreve:

plpgsql
Copy
Edit
RETURN QUERY
SELECT * FROM tabela WHERE condi√ß√£o;
Isso faz a fun√ß√£o enviar o resultado da consulta para fora.

4. Estrutura b√°sica de uma fun√ß√£o com RETURN QUERY
sql
Copy
Edit
CREATE OR REPLACE FUNCTION buscar_clientes_ativos()
RETURNS TABLE(id INT, nome TEXT, idade INT) AS $$
BEGIN
  RETURN QUERY
  SELECT id, nome, idade
  FROM clientes
  WHERE ativo = TRUE;
END;
$$ LANGUAGE plpgsql;
A fun√ß√£o retorna uma tabela com colunas id, nome e idade.

A consulta dentro do RETURN QUERY seleciona apenas clientes ativos.

5. Como usar essa fun√ß√£o
sql
Copy
Edit
SELECT * FROM buscar_clientes_ativos();
Essa consulta retorna todos os clientes ativos usando a fun√ß√£o.

6. Vantagens do RETURN QUERY
Facilita o reuso de consultas SQL dentro de fun√ß√µes.

Permite combinar l√≥gica procedural com consultas que retornam dados.

D√° mais organiza√ß√£o para c√≥digos que precisam retornar v√°rios resultados.

7. Observa√ß√µes importantes
A fun√ß√£o deve declarar que retorna uma tabela (RETURNS TABLE) ou um setof registros.

Pode usar RETURN QUERY v√°rias vezes dentro da mesma fun√ß√£o para adicionar resultados.

Depois de RETURN QUERY, voc√™ pode colocar qualquer comando SELECT v√°lido.

8. Exemplo com m√∫ltiplos RETURN QUERY
sql
Copy
Edit
CREATE OR REPLACE FUNCTION buscar_clientes_por_idade()
RETURNS TABLE(id INT, nome TEXT, idade INT) AS $$
BEGIN
  RETURN QUERY
  SELECT id, nome, idade FROM clientes WHERE idade < 30;

  RETURN QUERY
  SELECT id, nome, idade FROM clientes WHERE idade >= 30;
END;
$$ LANGUAGE plpgsql;
Retorna primeiro clientes jovens, depois clientes mais velhos.

Os resultados s√£o concatenados na sa√≠da da fun√ß√£o.

9. Resumo r√°pido
Conceito	Descri√ß√£o
RETURN QUERY	Retorna o resultado de uma consulta dentro da fun√ß√£o
Usado para	Fun√ß√µes que precisam devolver v√°rias linhas e colunas
Retorno da fun√ß√£o	Declara√ß√£o RETURNS TABLE ou RETURNS SETOF
Vantagem	Organiza consultas e l√≥gica em um √∫nico lugar