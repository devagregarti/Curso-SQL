ğŸ§­ Cursores (Cursors) no PL/pgSQL
âœ… O que Ã© um cursor?
Um cursor Ã© uma ferramenta usada para percorrer linha por linha o resultado de uma consulta (SELECT).

Ele Ã© como um marcador que vai passando por cada linha de uma tabela, uma de cada vez.

Muito Ãºtil quando vocÃª precisa processar cada linha separadamente, de forma controlada.

ğŸ§  Exemplo do mundo real
Imagine que vocÃª tem uma lista de nomes e quer enviar uma mensagem personalizada para cada pessoa.
O cursor permite pegar um nome por vez e executar uma aÃ§Ã£o.

ğŸ¯ Quando usar cursores?
Quando vocÃª precisa ler e processar vÃ¡rias linhas, uma por uma.

Quando a lÃ³gica depende do valor de cada linha individualmente.

Quando loops simples nÃ£o sÃ£o suficientes, por exemplo:

Enviar um e-mail por cliente.

Calcular valores personalizados por item.

Executar regras diferentes para cada linha.

âš ï¸ Quando nÃ£o usar?
Se vocÃª pode resolver tudo com um SELECT, UPDATE, ou JOIN, evite cursores.

Cursores sÃ£o mais lentos que operaÃ§Ãµes em lote.

Use apenas quando for necessÃ¡rio controlar o processamento linha a linha.

ğŸ§± Como funciona um cursor?
Declarar o cursor com uma consulta.

Abrir o cursor (abrir a â€œportaâ€ para a consulta).

Buscar (FETCH) a prÃ³xima linha.

Usar os dados da linha buscada.

Fechar o cursor no final.

ğŸ§ª Exemplo simples de cursor
sql
Copy
Edit
DO $$
DECLARE
  cliente_nome TEXT;
  meu_cursor CURSOR FOR SELECT nome FROM clientes;
BEGIN
  OPEN meu_cursor;

  LOOP
    FETCH meu_cursor INTO cliente_nome;
    EXIT WHEN NOT FOUND;

    RAISE NOTICE 'Nome do cliente: %', cliente_nome;
  END LOOP;

  CLOSE meu_cursor;
END;
$$;
ğŸ” O que acontece nesse exemplo:
CURSOR FOR SELECT â†’ define a consulta que serÃ¡ percorrida.

OPEN â†’ inicia o cursor.

FETCH INTO â†’ pega uma linha e coloca na variÃ¡vel cliente_nome.

EXIT WHEN NOT FOUND â†’ para o loop quando nÃ£o houver mais linhas.

CLOSE â†’ fecha o cursor.

ğŸ” Cursor + FOR LOOP (forma simplificada)
O PostgreSQL permite um jeito mais simples com FOR record IN cursor:

sql
Copy
Edit
DO $$
DECLARE
  cliente RECORD;
BEGIN
  FOR cliente IN SELECT nome FROM clientes LOOP
    RAISE NOTICE 'Cliente: %', cliente.nome;
  END LOOP;
END;
$$;
Mais limpo e direto.

Ãštil quando nÃ£o Ã© necessÃ¡rio controlar manualmente o cursor.

ğŸ¯ Por que usar cursores?
Permite controle total sobre o processamento das linhas.

Facilita aplicar regras especÃ­ficas para cada linha.

Boa opÃ§Ã£o quando outras abordagens sÃ£o complexas ou limitadas.

âœ… Resumo da aula
Cursores servem para percorrer resultado de consultas linha por linha.

SÃ£o Ãºteis quando o processamento depende de cada linha individualmente.

Use com cuidado: cursores sÃ£o poderosos, mas podem ser lentos.

No PostgreSQL, podemos usar:

A versÃ£o completa com OPEN, FETCH, CLOSE.

Ou uma versÃ£o simplificada com FOR ... IN SELECT.